<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Juego de Botellas Mejorado</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      text-align: center;
      padding: 20px;
      background: #eef3fb;
      overflow-x: hidden;
      user-select: none;
    }

    h1 {
      margin-bottom: 5px;
    }

    #controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    select {
      padding: 8px 12px;
      font-size: 1rem;
      border-radius: 8px;
      border: 2px solid #2980b9;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      cursor: pointer;
    }

    #game {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 40px;
      min-height: 380px;
      position: relative;
    }

    #boxContainer {
      position: relative;
      width: fit-content;
      padding: 20px;
      background: linear-gradient(145deg, #d6b887, #c1a663);
      border-radius: 10px;
      border: 3px solid #a17a38;
      box-shadow: inset 0 6px 8px #b99957, 0 8px 12px rgba(0,0,0,0.2);
      transition: opacity 0.8s ease;
    }

    #container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      max-width: 100%;
    }

    .bottle {
      width: 60px;
      height: 120px;
      border-radius: 15px 15px 40px 40px;
      border: 3px solid #333;
      background: linear-gradient(145deg, #c4dcff, #4367d8);
      box-shadow: inset 0 8px 15px rgba(255, 255, 255, 0.8), 0 8px 15px rgba(0, 0, 0, 0.3);
      position: relative;
      cursor: grab;
      user-select: none;
      transition: transform 0.4s ease;
    }

    .bottle::before {
      content: "";
      position: absolute;
      top: -15px;
      left: 50%;
      transform: translateX(-50%);
      width: 25px;
      height: 20px;
      background: linear-gradient(145deg, #a0b9f5, #334db2);
      border-radius: 12px 12px 5px 5px;
      box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.6);
    }

    .dancing {
      animation: dance 0.5s infinite ease-in-out alternate;
    }

    @keyframes dance {
      0% { transform: rotate(-3deg) translateY(-4px); }
      100% { transform: rotate(3deg) translateY(4px); }
    }

    #result {
      margin-top: 20px;
      font-size: 1.2rem;
      font-weight: bold;
      color: #334db2;
      min-height: 30px;
    }

    #finalOrder {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
      opacity: 0;
      transition: opacity 1s ease;
      pointer-events: none;
    }

    #resetBtn {
      margin-top: 25px;
      padding: 12px 28px;
      font-size: 1.2rem;
      font-weight: 700;
      color: white;
      background: linear-gradient(145deg, #2980b9, #1c5980);
      border: none;
      border-radius: 30px;
      box-shadow: 0 4px 8px rgba(41, 128, 185, 0.7);
      cursor: pointer;
      opacity: 0;
      pointer-events: none;
      transform-origin: center;
      user-select: none;
      transition: opacity 0.7s ease, transform 0.7s ease;
    }

    #resetBtn.show {
      opacity: 1;
      pointer-events: auto;
      animation: pulse 1.5s infinite alternate ease-in-out;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      100% { transform: scale(1.1); }
    }

    canvas {
      position: fixed;
      top: 0;
      left: 0;
      z-index: 20;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <h1>Ordena las Botellas ðŸ§ª</h1>
  <div id="controls">
    <select id="levelSelect">
      <option value="3">Nivel 1 (3 botellas)</option>
      <option value="4">Nivel 2 (4 botellas)</option>
      <option value="5" selected>Nivel 3 (5 botellas)</option>
    </select>
    <select id="modeSelect">
      <option value="normal">Modo Normal</option>
      <option value="reverse">Modo Inverso</option>
    </select>
  </div>
  <div id="game">
    <div id="boxContainer">
      <div id="container"></div>
    </div>
    <div id="result"></div>
    <div id="finalOrder"></div>
    <button id="resetBtn">Volver a jugar</button>
    <canvas id="confettiCanvas"></canvas>
<script>
const container = document.getElementById("container");
const result = document.getElementById("result");
const resetBtn = document.getElementById("resetBtn");
const finalOrder = document.getElementById("finalOrder");
const confettiCanvas = document.getElementById("confettiCanvas");
const levelSelect = document.getElementById("levelSelect");
const modeSelect = document.getElementById("modeSelect");
const boxContainer = document.getElementById("boxContainer");

const confettiCtx = confettiCanvas.getContext("2d");
confettiCanvas.width = window.innerWidth;
confettiCanvas.height = window.innerHeight;

let bottles = [];
let correctOrder = [];
let mode = "normal";
let dragging = null;

// Sonidos
const victorySound = new Audio("https://cdn.pixabay.com/download/audio/2022/03/15/audio_a3f1914e86.mp3?filename=success-1-6297.mp3");
const moveSound = new Audio("https://cdn.pixabay.com/download/audio/2022/02/23/audio_f8a3c94bc0.mp3?filename=wood-slide-2-8952.mp3");

// Marcar audio listo
victorySound.volume = 0.5;
moveSound.volume = 0.4;

function shuffle(array) {
  return array.map(a => [Math.random(), a])
              .sort((a, b) => a[0] - b[0])
              .map(a => a[1]);
}

function createBottle(index, total) {
  const div = document.createElement("div");
  div.classList.add("bottle");
  div.setAttribute("data-index", index);
  div.draggable = true;

  // Color fijo y distintivo segÃºn posicion y total
  const hue = Math.round((index * (360 / total)) % 360);
  div.style.background = `hsl(${hue}, 80%, 60%)`;

  return div;
}

function playMoveSound() {
  moveSound.currentTime = 0;
  moveSound.play();
}

function renderBottles() {
  container.innerHTML = "";
  bottles.forEach(bottle => container.appendChild(bottle));
}

function checkWin() {
  const current = Array.from(container.children).map(el => +el.dataset.index);
  const expected = mode === "reverse" ? [...correctOrder].reverse() : correctOrder;
  const correct = current.filter((val, idx) => val === expected[idx]).length;
  result.textContent = `Botellas en posiciÃ³n correcta: ${correct} de ${correctOrder.length}`;

  if (correct === correctOrder.length) {
    result.textContent = "Â¡Correcto! ðŸŽ‰";
    finalOrder.innerHTML = "";

    expected.forEach(i => {
      const clone = createBottle(i, correctOrder.length);
      clone.style.cursor = "default";
      finalOrder.appendChild(clone);
    });

    boxContainer.style.opacity = 0;
    finalOrder.style.opacity = 1;
    resetBtn.classList.add("show");

    victorySound.currentTime = 0;
    victorySound.play();
    triggerConfetti();
  }
}

function triggerConfetti() {
  let particles = [];
  for (let i = 0; i < 100; i++) {
    particles.push({
      x: Math.random() * confettiCanvas.width,
      y: Math.random() * -confettiCanvas.height,
      r: Math.random() * 6 + 4,
      d: Math.random() * 20 + 10,
      color: `hsl(${Math.random() * 360}, 100%, 50%)`,
      tilt: Math.random() * 10 - 5
    });
  }

  let angle = 0;
  function draw() {
    confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
    angle += 0.01;
    particles.forEach(p => {
      p.y += Math.cos(angle + p.d) + 1 + p.r / 2;
      p.x += Math.sin(angle) * 2;
      confettiCtx.beginPath();
      confettiCtx.fillStyle = p.color;
      confettiCtx.ellipse(p.x, p.y, p.r, p.r / 2, Math.PI / 4, 0, 2 * Math.PI);
      confettiCtx.fill();
    });
    particles = particles.filter(p => p.y < confettiCanvas.height);
    if (particles.length) requestAnimationFrame(draw);
  }
  draw();
}

function setupGame() {
  finalOrder.style.opacity = "0";
  resetBtn.classList.remove("show");
  boxContainer.style.opacity = "1";
  result.textContent = "";
  mode = modeSelect.value;

  const total = parseInt(levelSelect.value);
  bottles = [];
  for (let i = 0; i < total; i++) {
    bottles.push(createBottle(i, total));
  }
  correctOrder = bottles.map(b => +b.dataset.index);

  bottles = shuffle(bottles);
  bottles.forEach(b => b.classList.add("dancing"));

  setTimeout(() => {
    bottles.forEach(b => b.classList.remove("dancing"));
    renderBottles();
  }, 800);
}

function handleDragEvents() {
  container.addEventListener("dragstart", e => {
    if (e.target.classList.contains("bottle")) dragging = e.target;
  });

  container.addEventListener("dragover", e => {
    e.preventDefault();
    if (!dragging) return;

    const after = [...container.children].find(el => {
      const rect = el.getBoundingClientRect();
      return e.clientX < rect.left + rect.width / 2;
    });

    if (after && dragging !== after) {
      container.insertBefore(dragging, after);
    } else {
      container.appendChild(dragging);
    }
  });

  container.addEventListener("drop", () => {
    playMoveSound();
    checkWin();
  });

  container.addEventListener("dragend", () => { dragging = null; });
}

resetBtn.addEventListener("click", setupGame);
levelSelect.addEventListener("change", setupGame);
modeSelect.addEventListener("change", setupGame);

setupGame();
handleDragEvents();

</script>
</body>
</html>
